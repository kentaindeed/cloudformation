#------------------------------------------------------------#
#   CloudFormation 操作用のコマンド
#------------------------------------------------------------#

# aws cloudformation deploy dry run
aws cloudformation deploy \
--template-file alb-ecs.yml \
--stack-name ecs-test --no-execute-changeset

# aws cloudformation deploy production run
aws cloudformation deploy \
--template-file alb-ecs.yml \
--capabilities CAPABILITY_NAMED_IAM \
--stack-name ecs-test

#------------------------------------------------------------#
#   VPC構築 コマンド
#------------------------------------------------------------#


#vpc 構築
## 環境変数
EC2_VPC_CIDR='10.0.0.0/16'
EC2_VPC_NAME='cli-test-vpc'

# VPC 作成
aws ec2 create-vpc \
  --cidr-block ${EC2_VPC_CIDR} \
   --tag-specifications "ResourceType=vpc, Tags=[{Key=Name,Value=${EC2_VPC_NAME}}]"

#VPC ID 取得
EC2_VPC_ID=$( \
  --filters Name=tag:Name,Values=${EC2_VPC_NAME} \
  --query 'Vpcs[].VpcId' \
  --output text \
) \

# VPC ID 保存確認
echo ${EC2_VPC_ID}

# igw 構築


# igw attach

#subnet 構築


## 環境変数設定
EC2_SUBNET_CIDR_Public_A='10.0.10.0/24'
EC2_SUBNET_CIDR_Public_C='10.0.20.0/24'
EC2_SUBNET_CIDR_Private_A='10.0.30.0/24'
EC2_SUBNET_CIDR_Private_C='10.0.40.0/24'

EC2_AZ_CODE_A="a"
EC2_AZ_CODE_C="c"

EC2_AZ_NAME_A=${AWS_DEFAULT_REGION}${EC2_AZ_CODE_A} 
EC2_AZ_NAME_C=${AWS_DEFAULT_REGION}${EC2_AZ_CODE_C} 

echo ${EC2_AZ_NAME_A}
echo ${EC2_AZ_NAME_C}

EC2_SUBNET_TYPE_public="public"
EC2_SUBNET_TYPE_private="private"


EC2_SUBNET_TAG_NAME_PUB_1="cli-test-"${EC2_SUBNET_TYPE_public}"-subnet-"${EC2_AZ_CODE_A}
EC2_SUBNET_TAG_NAME_PUB_2="cli-test-"${EC2_SUBNET_TYPE_public}"-subnet-"${EC2_AZ_CODE_C}
EC2_SUBNET_TAG_NAME_PRI_1="cli-test-"${EC2_SUBNET_TYPE_private}"-subnet-"${EC2_AZ_CODE_C}
EC2_SUBNET_TAG_NAME_PRI_2="cli-test-"${EC2_SUBNET_TYPE_private}"-subnet-"${EC2_AZ_CODE_C}



### public subnet az-a
aws ec2 create-subnet \
  --vpc-id ${EC2_VPC_ID} \
  --cidr-block ${EC2_SUBNET_CIDR_Public_A} \
  --availability-zone ${EC2_AZ_NAME_A} \
  --tag-specifications ${EC2_SUBNET_TAG_NAME_PUB_1}

### public subnet az-c
aws ec2 create-subnet \
  --vpc-id ${EC2_VPC_ID} \
  --cidr-block ${EC2_SUBNET_CIDR_Public_C} \
  --availability-zone ${EC2_AZ_NAME_C} \
  --tag-specifications ${EC2_SUBNET_TAG_NAME_PUB_2}

## private subnet *2

### private subnet az-a
aws ec2 create-subnet \
  --vpc-id ${EC2_VPC_ID} \
  --cidr-block ${EC2_SUBNET_CIDR_Private_A} \
  --availability-zone ${EC2_AZ_NAME_A} \
  --tag-specifications ${EC2_SUBNET_TAG_NAME_PRI_1}

### private subnet az-c
aws ec2 create-subnet \
  --vpc-id ${EC2_VPC_ID} \
  --cidr-block ${EC2_SUBNET_CIDR_Private_C} \
  --availability-zone ${EC2_AZ_NAME_C} \
  --tag-specifications ${EC2_SUBNET_TAG_NAME_PRI_2}


# sg alb <=> ec2 
EC2_SECURITY_GROUP_DESCRIPTION='handson-cli alb-ec2.'

aws ec2 create-security-group \
  --group-name ${EC2_SECURITY_GROUP_NAME} \
  --description "${EC2_SECURITY_GROUP_DESCRIPTION}" \
  --vpc-id ${EC2_VPC_ID}


# sg client <=> alb
EC2_SECURITY_GROUP_DESCRIPTION='handson-cli alb.'


aws ec2 create-security-group \
  --group-name ${EC2_SECURITY_GROUP_NAME} \
  --description "${EC2_SECURITY_GROUP_DESCRIPTION}" \
  --vpc-id ${EC2_VPC_ID}
